---
ticket: PROD-28299
title: Contr√¥le sur la date de perte du mandat
status: en_cours
domain: gl
team: amarillo
tags: [validation, mandat, service-lease, plato, myfoncia]
created: 2025-11-20
updated: 2025-11-28
---

# PROD-28299 - Contr√¥le sur la date de perte du mandat

## Contexte

**Jira** : [PROD-28299](https://fonciamillenium.atlassian.net/browse/PROD-28299)
**Titre** : CM-G Etablir un contr√¥le sur l'enregistrement de la date de perte sur la fiche mandat et sur le bailleur
**Domaine** : GL (Gestion Locative) ‚Üí Fiche Mandat
**√âquipe** : AMARILLO

---

## üìã R√©sum√© court

**Probl√®me** : Un utilisateur peut saisir une date de fin de mandat (`finalClosingDate`) alors que des lots sont encore actifs ‚Üí √ßa bloque les CRG et cr√©e des incoh√©rences.

**Solution** : Emp√™cher la saisie si au moins un lot est encore actif.

---

## üìñ Explication d√©taill√©e

### 1. Contexte historique

Avant, la date de fin (`finalClosingDate`) sur la fiche Mandat √©tait **purement informative** :
- Pas d'impact sur les lots
- Pas d'impact sur les CRG
- Pas d'impact sur myFoncia

### 2. Situation actuelle (probl√®me)

Depuis les derni√®res √©volutions, `finalClosingDate` a un **impact r√©el** :

```
finalClosingDate renseign√©e
        ‚Üì
   Mandat consid√©r√© "ferm√©"
        ‚Üì
   ‚ùå CRG bloqu√©s
   ‚ùå Compte myFoncia restreint
```

**Mais** : rien n'emp√™che l'utilisateur de saisir cette date m√™me si des lots sont encore actifs !

### 3. Cas probl√©matique concret

```
Mandat GL-12345
‚îú‚îÄ‚îÄ Lot A : actif (endManagementDate = null)      ‚Üê Encore g√©r√© !
‚îú‚îÄ‚îÄ Lot B : actif (endManagementDate = null)      ‚Üê Encore g√©r√© !
‚îî‚îÄ‚îÄ finalClosingDate = 2025-01-15                 ‚Üê Saisi par erreur

R√©sultat :
- Lots toujours g√©r√©s en th√©orie
- Mais mandat "ferm√©" ‚Üí CRG bloqu√©s ‚Üí probl√®me !
```

### 4. Comportement attendu (cible)

```
Utilisateur veut saisir finalClosingDate
        ‚Üì
   V√©rification : tous les lots sont-ils inactifs ?
        ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  OUI (tous inactifs)   ‚îÇ  NON (au moins 1 actif)  ‚îÇ
   ‚îÇ         ‚Üì              ‚îÇ            ‚Üì             ‚îÇ
   ‚îÇ   ‚úÖ Saisie OK         ‚îÇ   ‚ùå Erreur + message    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Message d'erreur** :
> "Impossible de d√©finir une date de fin de mandat : des lots sont encore actifs. Veuillez d'abord cl√¥turer tous les lots."

---

## D√©finition d'un lot actif

Un lot est consid√©r√© comme **actif** si :
- `endManagementDate` est `null` ou `undefined`
- OU `endManagementDate` est dans le futur (> now)

---

## Fichiers modifi√©s

| Fichier | Description |
|---------|-------------|
| `applications/plato/src/routes/housings/rentalManagementMandate/rentalManagementMandate.process.js` | Route Plato (PATCH) - Validation c√¥t√© legacy |
| `applications/service-lease/worker/src/rental-management-mandate/repository/rental-management-mandate.repository.ts` | Interface repository |
| `applications/service-lease/worker/src/rental-management-mandate/adapter/mongodb-rental-management-mandate.repository.ts` | Impl√©mentation MongoDB - `hasActiveUnits()` |
| `applications/service-lease/worker/src/rental-management-mandate/domain/update-rental-management-mandate.use-case.ts` | Use case avec validation |

---

## Flux de validation

### 1. Flux Plato (PATCH /api/rentalManagementMandates/:id)

```
updateOneRentalManagementMandate()
  ‚Üì
Si endMandateDate ou finalClosingDate fourni
  ‚Üì
validateNoActiveUnitsForEndDate()
  ‚Üì
hasActiveUnits() ‚Üí v√©rifie endManagementDate de chaque lot
  ‚Üì
Si actifs ‚Üí throw CommonException "MANDATE_HAS_ACTIVE_UNITS"
```

**Message d'erreur** : *"Impossible de d√©finir une date de fin de mandat : des lots sont encore actifs. Veuillez d'abord cl√¥turer tous les lots."*

### 2. Flux service-lease (Temporal Workflow)

```
updateRentalManagementMandate() [use-case]
  ‚Üì
Si finalClosingDate fourni
  ‚Üì
validateNoActiveUnitsForFinalClosingDate()
  ‚Üì
repository.hasActiveUnits()
  ‚Üì
Si actifs ‚Üí BusinessException "ActiveUnitsExistException"
```

**Message d'erreur** : *"Impossible de d√©finir une date de perte : des lots sont encore actifs sur ce mandat. Veuillez d'abord cl√¥turer tous les lots."*

---

## Sch√©ma des flux

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         FRONTEND                                 ‚îÇ
‚îÇ   FinalClosingDateField (smarties)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Gateway    ‚îÇ        ‚îÇ    Plato     ‚îÇ
‚îÇ   GraphQL    ‚îÇ        ‚îÇ   REST API   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                       ‚îÇ
       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ service-lease‚îÇ        ‚îÇ rentalManagement     ‚îÇ
‚îÇ   Temporal   ‚îÇ        ‚îÇ Mandate.process.js   ‚îÇ
‚îÇ   Workflow   ‚îÇ        ‚îÇ                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                           ‚îÇ
       ‚ñº                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Use Case    ‚îÇ        ‚îÇ  ‚ö†Ô∏è VALIDATION ICI   ‚îÇ
‚îÇ  ‚ö†Ô∏è VALID.   ‚îÇ        ‚îÇ                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                           ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    MongoDB      ‚îÇ
         ‚îÇ rentalManagement‚îÇ
         ‚îÇ    Mandates     ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Test

**Voir** : [LOCAL_BO_ACCESS.md](./LOCAL_BO_ACCESS.md) pour les instructions d'acc√®s au BO local.

### Donn√©es de test

| Champ | Valeur |
|-------|--------|
| **Cabinet** | FONCIA AD IMMOBILIER (0580) |
| **Bailleur** | 200209356 |
| **Mandat ID** | `64850e80954504c6fd1095bd` |
| **Lot actif** | N¬∞1766 (sans `endManagementDate`) |

**URL Local** :
```
http://localhost:8081/customer/64850e80de2125571ec2a82b/lessor?activeLessor=64850e80954504c6fd1095bc&activeMandates=0&mandateId=64850e80954504c6fd1095bd
```

### Proc√©dure de test

1. Se connecter au BO via impersonate (cabinet AD Immobilier)
2. Acc√©der au bailleur 200209356
3. Ouvrir le mandat
4. Essayer de saisir une **Date de perte** (`finalClosingDate`)
5. **R√©sultat attendu** : Message d'erreur bloquant

### Requ√™tes MongoDB

```javascript
// V√©rifier l'√©tat du mandat
db.rentalManagementMandates.findOne(
  { _id: ObjectId("64850e80954504c6fd1095bd") },
  { finalClosingDate: 1, "units.rentalManagement.endManagementDate": 1 }
)

// R√©initialiser pour retest
db.rentalManagementMandates.updateOne(
  { _id: ObjectId("64850e80954504c6fd1095bd") },
  { $unset: { finalClosingDate: "" } }
)
```

---

## Lien avec INC-106061 (myFoncia restriction)

> **Contexte** : Ce ticket est li√© √† l'incident INC-106061 o√π des comptes myFoncia sont incorrectement restreints.

### Probl√®me d√©couvert

La logique de restriction myFoncia (`customerQualities.repository.ts`) calcule `isActive` au niveau du **LOT** (pas du mandat) :

```typescript
// Si TOUS les lots ont endManagementDate dans le pass√© ‚Üí compte restreint
isActive: {
  $cond: {
    if: { $or: [
      { $eq: ["$endManagementDate", null] },
      { $gt: ["$endManagementDate", new Date()] },
    ]},
    then: true,
    else: false,
  }
}
```

### Cons√©quence

```
Mandat openMandate: true (toujours ouvert)
‚îî‚îÄ‚îÄ Tous les lots avec endManagementDate dans le pass√©
    ‚Üì
Compte myFoncia RESTREINT (m√™me si mandat ouvert !)
```

### Ampleur (base locale)

| M√©trique | Valeur |
|----------|--------|
| Mandats `openMandate: true` avec lots "perdus" | ~32 785 |
| Lots avec `endManagementDate` pass√©e | ~70 206 |
| Mandats avec TOUS les lots "perdus" | ~77 839 |

### Lien avec PROD-28299

Ce ticket PROD-28299 emp√™che la saisie de `finalClosingDate` si des lots actifs existent, mais ne r√©sout pas le probl√®me inverse : des lots marqu√©s "perdus" alors que le mandat est toujours ouvert.

---

## Tests cr√©√©s

| Couche | Fichier | Description |
|--------|---------|-------------|
| **Use Case** | `service-lease/worker/.../domain/use-cases/__tests__/update-rental-management-mandate.usecase.spec.ts` | Test unitaire du use case avec mock du repository |
| **Repository** | `service-lease/worker/.../adapter/__tests__/mongodb-rental-management-mandate.repository.spec.ts` | Test d'int√©gration de `hasActiveUnits()` |
| **Plato Process** | `plato/.../housings/rentalManagementMandate/__tests__/validate-final-closing-date.spectegration.ts` | Test d'int√©gration de la route PATCH |

### Commandes pour lancer les tests

```bash
# service-lease (Vitest)
pnpm nx test service-lease-worker -- --grep "hasActiveUnits"
pnpm nx test service-lease-worker -- --grep "UpdateRentalManagementMandateUseCase"

# Plato (Jest)
pnpm nx test:jest plato -- validate-final-closing-date
```

---

## TODO

- [x] Lecture du contexte du ticket
- [x] Analyse du code modifi√©
- [x] Investigation INC-106061 (lien avec myFoncia)
- [x] Cr√©ation des tests unitaires et d'int√©gration
- [ ] Ex√©cuter les tests en local
- [ ] Validation en PP

---

## Diff complet

Voir [PROD-28299-DIFF.md](./PROD-28299-DIFF.md) pour le diff d√©taill√© des modifications.
