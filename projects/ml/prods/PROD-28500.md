---
ticket: PROD-28500
status: investigation
priority: Medium
domain: GL
subdomain: Mission Commercialisation
cabinet: Brette
created: 2025-06-05
---

# PROD-28500 - Affichage nom personne morale incorrect

## Problème

Sur les missions de commercialisation, lorsque le bailleur ou le locataire est une **personne morale** (SCI, hôpital, etc.), c'est le nom du **représentant légal** qui s'affiche au lieu du **nom de la société**.

## Données de test

| Champ | Valeur |
|-------|--------|
| Mission | `70012P73T` |
| Mission ID | `68f8e15926438989ae910ab0` |
| Cabinet | Brette |
| URL | `https://foncia-adb.fonciamillenium.net/mission/commercialisation/68f8e15926438989ae910ab0/etat-des-lieux-entree` |

## Comportement attendu

- **Personne morale** : Afficher le nom de la société (ex: "SCI DUPONT")
- **Personne physique** : Afficher le nom de la personne (ex: "Jean DUPONT")

## Comportement actuel

- **Personne morale** : Affiche le nom du représentant légal au lieu du nom de la société

## Investigation

### Cause racine identifiée ✅

**Problème** : Le champ `fullname` stocké en base de données contient le nom du représentant légal pour les personnes morales, pas le nom de la société.

**Source** : `/applications/plato/src/models/users/customer.ts` (lignes 415-424)
```typescript
// Calculé mais pas un virtual pour power faire du search dessus
fullname: {
  type: String,
  required(this: CustomerType) {
    return this.legalEntity === userLegalEntity.PERSON;
  },
  // ...
}
```

Le `fullname` est :
- **PERSON** : `firstName + lastName` (correct)
- **COMPANY** : Contient souvent le nom du représentant légal au lieu de `companyInformations.company.companyName`

### Flux d'affichage

```
PageEntryUnitAssessment (état des lieux)
  └── ViewCustomerInformations
       └── CardTenantsLessor
            └── CardCustomer
                 └── Affiche `customer.fullname` ❌
```

### Solution existante (non appliquée partout)

Le DAO MyFoncia a la bonne logique :
```javascript
// /applications/plato/src/routes/myfoncia/user/customer/customer.dao.js
fullname: {
  $ifNull: ["$companyInformations.company.companyName", "$fullname"],
}
```

### Fichiers impactés

| Fichier | Rôle |
|---------|------|
| `front-adb/src/components/CardCustomer/index.tsx` | Composant d'affichage |
| `front-adb/src/components/CardTenantsLessor/index.tsx` | Wrapper lessors/tenants |
| `front-adb/src/pages/FicheMissionMarketing/PageEntryUnitAssessment/index.jsx` | Page état des lieux |
| `packages/transformers/src/mappers/lease.js` | Mapper lessorPrincipal |

### Vérification données de test

Customer du ticket (`64ab4a00d4620a1c729a2665`) :
```json
{
  "legalEntity": "COMPANY",
  "fullname": "Company_004303847",      // ✅ Contient le nom société
  "firstName": "Patrice_Ano",            // Représentant légal
  "lastName": "Fournier_Ano",            // Représentant légal
  "companyInformations.company.name": "Company_004303847"  // ✅
}
```

**Observation** : Dans ce cas de test, le `fullname` est correctement rempli avec le nom de la société. Le bug pourrait concerner d'autres customers où le `fullname` a été mal rempli lors de la migration.

### Fix existant dans CardCustomer

Le composant a **déjà** la bonne logique (ligne 48) :
```typescript
const customerName = companyInformations?.company?.name ?? fullname;
```

### Hypothèses du bug

1. **Données mal migrées** : Certains customers `COMPANY` ont un `fullname` = représentant légal
2. **companyInformations non chargé** : Le champ n'est pas populé dans certains flux
3. **Autre page/composant** : Le bug pourrait être sur une autre page que `CardCustomer`

### Options de fix

**Option A - Frontend robuste** : Ajouter `legalEntity` aux props et forcer l'utilisation de `companyName`

**Option B - Mapper** : Modifier `findMainLessor` dans `lease.js` pour normaliser le nom

**Option C - Data fix** : Corriger les `fullname` incorrects en base via script de migration

### Prochaines étapes

- [ ] Reproduire le bug avec les données exactes du cabinet Brette
- [ ] Identifier un customer avec `fullname` incorrect
- [ ] Choisir l'option de fix appropriée

## Commits

| Date | Commit | Description |
|------|--------|-------------|
| - | - | - |

## Notes

- Le représentant légal est stocké dans `legalRepresentative` sur le customer
- Le nom de société est dans `companyName`
- Le type est déterminé par `customerType` ou `isCompany`
