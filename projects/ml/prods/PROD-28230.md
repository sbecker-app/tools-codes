---
ticket: PROD-28230
title: Mises en demeure non envoyees copropriétaires
status: en_cours
domain: gl
team: amarillo
tags: [litigation, recovery, copro, mise-en-demeure, N2, snowflake, datadog, writeConflict]
assignee: FRX33355
created: 2025-12-03
updated: 2025-12-03
---

# PROD-28230 - CONTENTIEUX - MISE EN DEMEURE NON ENVOYEES

## Contexte

- **Date de l'incident** : 04/11/2025
- **Probleme** : Plusieurs coproprietaires n'ont pas recu leur mise en demeure (niveau 2)
- **Impact** : 7 coproprietaires bloques au niveau 1 sur 8 signales

## Resultats investigation Snowflake (03/12/2025)

### Tableau recapitulatif

| # Compte | Nom | Agence | Level | Raison | Detail |
|----------|-----|--------|-------|--------|--------|
| **101785816** | LE PARC DES SEPT DENIERS | TOULOUSE | **2.0** | **OK** | Seul a avoir recu N2 (26/11/2025) |
| **101291139** | JANINE ACCOT | NICE | 1.0 | **N2 envoye mais isExcluded:true** | Event "Copro 2" present le 04/11 mais exclu |
| **102732743** | CORENTIN DIASCORN | TERRE OCCITANE | 1.0 | **LEVEL_UPDATE manuel** | Passe N0->N1 manuellement le 03/11, jamais de N2 |
| **102740597** | MORIEUX/HOARAU | TERRE OCCITANE | 1.0 | **NEVER_PROCESSED** | Next Reminder: 2024-10-09 (>1 an!), aucun event REMINDER |
| **103034606** | MAURICE ALAYRAC | MARSEILLE | 1.0 | **CALCULATED_AMOUNT_UNDER_RECOVERY_AMOUNT** | Exclusion explicite dans events du 28/10/2024 |
| **103041737** | LAURENT BONIER | MARSEILLE | 1.0 | **N2 envoye mais isExcluded:true** | Event "Copro 2" present le 04/11 mais exclu |
| **103046879** | BRUNO SEGUIN | MARSEILLE | 1.0 | **PAS de N2** | A recu "Copro 1" le 20/10/2025, jamais de N2 |
| **103144223** | LUDOVIC SANTOS | TERRE OCCITANE | 1.0 | **PAS de N2** | A recu "Copro 1" le 20/10/2025, modification manuelle le 29/10 |

### Donnees Snowflake detaillees

| # Compte | Amount (EUR) | Calculated (EUR) | Auto Reminder | Last Reminder | Recovery ID |
|----------|--------------|------------------|---------------|---------------|-------------|
| 101785816 | 3740.16 | 3680.16 | True | 2025-11-26 | 68dcbf4d1b778399d912fb75 |
| 101291139 | 806.35 | 777.42 | True | None | 68dc86391b778399d9e3ce46 |
| 102732743 | 214.69 | 96.27 | True | None | 68dca1e11b778399d9f9e42a |
| 102740597 | 1542.54 | 1104.08 | True | None | 66ff32ac610e3077e4ec17fe |
| 103034606 | 2011.09 | 1200.22 | True | 2025-10-20 | 66ff4bd0610e3077e4edc7ba |
| 103041737 | 881.08 | 407.62 | True | None | 68ddfc5cde50e17d0c77da4d |
| 103046879 | 907.32 | 735.99 | True | None | 67ee0e285d2af9484b88f22b |
| 103144223 | 211.33 | 211.33 | True | None | 68de10ac4242e9fd5dd19f01 |

## Analyse des causes racines

### 1. CALCULATED_AMOUNT_UNDER_RECOVERY_AMOUNT (1 cas)

**MAURICE ALAYRAC (103034606)** :
- Exclu explicitement car `calculated_amount (1200.22) < recovery_amount (2011.09)`
- Event du 28/10/2024 : `"exclusionReason": "CALCULATED_AMOUNT_UNDER_RECOVERY_AMOUNT", "isExcluded": true`

### 2. N2 envoye mais isExcluded:true (2 cas suspects)

**JANINE ACCOT (101291139)** et **LAURENT BONIER (103041737)** :
- Les events montrent un "Copro 2" du 04/11/2025
- Mais avec `isExcluded: true` → le courrier n'a pas ete genere/envoye
- **A investiguer** : pourquoi l'exclusion sans raison explicite ?

### 3. Jamais traite / NEVER_PROCESSED (1 cas)

**MORIEUX/HOARAU (102740597)** :
- `Next Reminder: 2024-10-09` → dossier "oublie" depuis plus d'un an
- Aucun event REMINDER dans l'historique
- Dossier cree le 04/10/2024, jamais traite depuis

### 4. Event N2 cree mais level non incremente (2 cas - SEGUIN & SANTOS)

**BRUNO SEGUIN (103046879)** et **LUDOVIC SANTOS (103144223)** :

**Donnees MongoDB (dump prod du 03/12/2025) :**
- Event "Copro 2 du 04/11/2025" **EXISTE** avec `isExcluded: false`
- `notificationsHistory: []` (vide)
- `level: 1` (non incremente a 2)

**Analyse du code :**

Le workflow Temporal `SendReminderActivity` fait 2 operations en parallele :
```typescript
Future.all([
  this.addRecoveryReminderFileEvent(recoveryFileId, reminder),  // ✅ SUCCESS
  this.updateRecoveryFileToNextLevel(recoveryFileId, reminder.level),  // ❌ FAIL
])
```

**Cause identifiee :**
1. L'event a ete cree avec succes via `createRecoveryFileEventReminderWithComment`
2. La mutation `setRecoveryFileLevelMutation` a echoue (gateway timeout? erreur reseau?)
3. Le consumer AMQP Plato (`dunningreminder_V2.1`) n'a pas traite le message
4. Resultat : event cree, mais ni level ni PDF/outgoingMail

**Verification MongoDB (03/12/2025) :**
- `notificationsHistory: []` (vide) pour les 2 dossiers → confirme que le consumer AMQP n'a jamais traite ces messages

### 5. N1 recu mais N2 non declenche (1 cas - DIASCORN)

**CORENTIN DIASCORN (102732743)** :
- A recu N1 le 20/10/2025
- Aucun event "Copro 2" dans l'historique
- Passage N0->N1 manuel le 03/11 (intervention manuelle)
- Probablement exclu du batch automatique

## Diagnostic

### Hypothese principale confirmee

Le batch du **04/11/2025** a bien tente d'envoyer les N2, mais plusieurs problemes sont survenus :

1. **Echec partiel du workflow Temporal** (SEGUIN, SANTOS) :
   - Event REMINDER cree avec succes
   - Mutation de mise a jour du level echouee
   - Consumer AMQP non execute → pas de PDF/mail

2. **Exclusion explicite** (`isExcluded: true`) sans raison detaillee (ACCOT, BONIER)

3. **Exclusion pour montant** (`CALCULATED_AMOUNT_UNDER_RECOVERY_AMOUNT`) pour ALAYRAC

4. **Non inclus dans le batch** (DIASCORN - intervention manuelle precedente)

5. **Dossier orphelin** depuis >1 an (MORIEUX/HOARAU)

### ✅ BUG CORRIGE : Race condition dans `send-reminder.ts`

**Localisation** : `service-litigation/worker/src/recovery-file/activities/send-reminder.ts` (lignes 178-186)

**Commit de correction** : `b216319b49d` - "feat: fixe write conflic" (03/12/2025 17:04 par sebastien.becker.externe)

**Code AVANT (bug)** :
```typescript
return Future.all([
  this.addRecoveryReminderFileEvent(recoveryFileId, reminder),   // Mutation 1
  this.updateRecoveryFileToNextLevel(recoveryFileId, reminder.level),  // Mutation 2
])
  .map(Result.all)
```

**Probleme** :
- Les 2 mutations s'executaient **en parallele** sur le meme document MongoDB
- Si mutation 1 reussit avant mutation 2, MongoDB detecte un **write conflict**
- Mutation 2 echoue mais mutation 1 est deja commitee → **etat incoherent**

**Code APRES (fix)** :
```typescript
// Mutations sequentielles (pas de race condition)
return this.addRecoveryReminderFileEvent(recoveryFileId, reminder)
  .flatMapOk(() => this.updateRecoveryFileToNextLevel(recoveryFileId, reminder.level))
```

> Note: Le gateway ne supporte pas les transactions MongoDB, donc la seule solution est de rendre les mutations sequentielles.
>
> ✅ **FIX DEPLOYE** : A verifier en PROD apres le prochain deploiement.

### Preuves Datadog PROD (03/12/2025)

**Requete utilisee** :
```
@attr.writeConflicts:>=1 @attr.ns:plato.recoveryFiles
```

**Resultats** : **10 writeConflicts** sur `plato.recoveryFiles` sur le dernier mois

| Date | Heure | Collection | Operation | lineOfBusiness | Level | writeConflicts |
|------|-------|------------|-----------|----------------|-------|----------------|
| 24/11/2025 | 21:55 - 22:05 | plato.recoveryFiles | UPDATE | S (Syndic/Copro) | 3 | 1 |
| ... | ... | ... | ... | S | ... | 1 |

**Observations** :
- **Tous les 10 writeConflicts** sont concentres sur une fenetre de **~10 minutes** (24/11/2025 21:55-22:05)
- Tous concernent des dossiers **Copropriete** (`lineOfBusiness: S`)
- Operations UPDATE avec `$set` sur `level`, `external`, `updatedAt`
- Duration moyenne : ~200ms (slow query)

**Conclusion** : Cela confirme que la race condition `Future.all()` cause des write conflicts reels en production lors des batchs de relances.

**Lien Datadog PROD** : https://foncia-stark.datadoghq.eu/logs

### Conditions de blocage identifiees

| Condition | Cas concernes | Fichiers |
|-----------|---------------|----------|
| **Race condition Future.all** | SEGUIN, SANTOS | `send-reminder.ts:178-186` |
| `isExcluded: true` sans raison | ACCOT, BONIER | A investiguer |
| `CALCULATED_AMOUNT_UNDER_RECOVERY_AMOUNT` | ALAYRAC | Normal |
| Non inclus (intervention manuelle) | DIASCORN | A confirmer |
| Dossier orphelin (>1 an) | MORIEUX/HOARAU | Bug ancien |

## Actions correctives proposees

### Court terme (data fix)

- [ ] Corriger manuellement les 7 dossiers bloques (PData ou intervention manuelle)
- [ ] Traiter le dossier MORIEUX/HOARAU (orphelin depuis >1 an)

### Moyen terme (bug fix)

- [x] **FIX BUG** : Modifier `send-reminder.ts` pour rendre les mutations sequentielles ✅
  - Fichier : `service-litigation/worker/src/recovery-file/activities/send-reminder.ts`
  - Commit : `b216319b49d` (03/12/2025 - sebastien.becker.externe)
- [ ] Investiguer les cas `isExcluded: true` sans raison (ACCOT, BONIER)
- [ ] Verifier si d'autres dossiers sont dans le meme cas (requete Snowflake)

### Long terme (monitoring)

- [ ] Ajouter une alerte pour detecter les dossiers avec event REMINDER mais level non incremente
- [ ] Ajouter un check pour les dossiers avec `next_reminder` > 30 jours dans le passe
- [ ] Ameliorer le logging des raisons d'exclusion (toujours expliciter `exclusionReason`)

## Scripts utiles

### Requete Snowflake - Dossiers bloques niveau 1

```sql
SELECT
    CO_OWNER_FULL_NAME,
    CO_OWNER_ACCOUNT_NUMBER,
    AGENCY_NAME,
    LEVEL,
    AMOUNT / 100.0 as AMOUNT_EUR,
    CALCULATED_AMOUNT / 100.0 as CALCULATED_EUR,
    LAST_REMINDER_DATE,
    NEXT_REMINDER_DATE,
    RECOVERY_FILE_ID
FROM DATAMART_ML_PROD.ACCOUNTING.RECOVERY_CO
WHERE RECOVERY_STATUS = 'ONGOING_REMINDER'
  AND LEVEL = 1
  AND AUTOMATIC_REMINDER = TRUE
  AND (LAST_REMINDER_DATE IS NULL OR DATEDIFF('day', LAST_REMINDER_DATE, CURRENT_DATE) > 30)
ORDER BY AGENCY_NAME, CO_OWNER_FULL_NAME;
```

### Requete Snowflake - Dossiers orphelins (next_reminder ancien)

```sql
SELECT
    CO_OWNER_FULL_NAME,
    CO_OWNER_ACCOUNT_NUMBER,
    AGENCY_NAME,
    LEVEL,
    NEXT_REMINDER_DATE,
    DATEDIFF('day', NEXT_REMINDER_DATE, CURRENT_DATE) as DAYS_OVERDUE,
    RECOVERY_FILE_ID
FROM DATAMART_ML_PROD.ACCOUNTING.RECOVERY_CO
WHERE RECOVERY_STATUS = 'ONGOING_REMINDER'
  AND NEXT_REMINDER_DATE < DATEADD('day', -30, CURRENT_DATE)
ORDER BY DAYS_OVERDUE DESC
LIMIT 50;
```

## Architecture du code (reference)

### Flow d'envoi de relance copro (service-litigation → plato)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    SERVICE-LITIGATION (Temporal)                    │
├─────────────────────────────────────────────────────────────────────┤
│ SendReminderActivity.execute()                                      │
│   ├── sendCoOwnerReminderUsecase.sendReminder()                     │
│   │     ├── canSendReminder() → 8 conditions                        │
│   │     └── sendNotifications() → publie AMQP                       │
│   │                                                                 │
│   └── updateRecoveryFile() [si status === SENT]                     │
│         ├── addRecoveryReminderFileEvent() → mutation gateway       │
│         └── updateRecoveryFileToNextLevel() → mutation gateway      │
└─────────────────────────────────────────────────────────────────────┘
                              │ AMQP
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         PLATO (Consumer)                            │
├─────────────────────────────────────────────────────────────────────┤
│ dunningreminder.ts (queue: dunningreminder_V2.1)                    │
│   └── sendCoOwnershipDunningReminder()                              │
│         ├── sendDunningRemindersLevel2()                            │
│         │     ├── generatePdfForCoOwner()                           │
│         │     ├── createOutgoingMail()                              │
│         │     └── pushRecoveryFileHistory() → notificationsHistory  │
│         └── updateRecoveryFile({dates.lastRelance})                 │
└─────────────────────────────────────────────────────────────────────┘
```

### Fichiers cles

| Fichier | Role |
|---------|------|
| `service-litigation/.../send-co-owner-reminder.ts` | Conditions d'envoi + publication AMQP |
| `service-litigation/.../send-reminder.ts` | Activity Temporal, update level |
| `plato/.../dunningreminder.ts` | Consumer AMQP |
| `plato/.../coOwnership/index.ts` | Orchestration envoi copro |
| `plato/.../coOwnership/level2/index.ts` | Generation PDF N2 + outgoingMail |

## References

- [send-co-owner-reminder.ts](../millenium/applications/service-litigation/worker/src/recovery-file/adapters/send-co-owner-reminder.ts) - Conditions d'envoi
- [send-reminder.ts](../millenium/applications/service-litigation/worker/src/recovery-file/activities/send-reminder.ts) - Activity Temporal
- [coOwnership/index.ts](../millenium/applications/plato/src/routes/accounting/recovery/recovery.process/dunningReminders-ts/coOwnership/index.ts) - Consumer Plato
- [Script investigation Snowflake](../scripts/snowflake_prod28230.py)
- [Ticket Jira PROD-28230](https://fonciamillenium.atlassian.net/browse/PROD-28230)
