---
ticket: PROD-28299
title: Contr√¥le sur la date de perte du mandat
status: committed
domain: gl
team: amarillo
tags: [validation, mandat, plato, smarties, frontend-blocking, performance]
created: 2025-11-20
updated: 2025-12-04
commit: 99161b8d36b
branch: revert-34b6d3ca
---

# PROD-28299 - Contr√¥le sur la date de perte du mandat

## Contexte

**Jira** : [PROD-28299](https://fonciamillenium.atlassian.net/browse/PROD-28299)
**Titre** : CM-G Etablir un contr√¥le sur l'enregistrement de la date de perte sur la fiche mandat et sur le bailleur
**Domaine** : GL (Gestion Locative) ‚Üí Fiche Mandat
**√âquipe** : AMARILLO

---

## üìã R√©sum√© court

**Probl√®me** : Un utilisateur peut saisir une date de fin de mandat (`finalClosingDate`) alors que des lots sont encore actifs ‚Üí √ßa bloque les CRG et cr√©e des incoh√©rences.

**Solution** : Emp√™cher la saisie si au moins un lot est encore actif.

---

## üìñ Explication d√©taill√©e

### 1. Contexte historique

Avant, la date de fin (`finalClosingDate`) sur la fiche Mandat √©tait **purement informative** :
- Pas d'impact sur les lots
- Pas d'impact sur les CRG
- Pas d'impact sur myFoncia

### 2. Situation actuelle (probl√®me)

Depuis les derni√®res √©volutions, `finalClosingDate` a un **impact r√©el** :

```
finalClosingDate renseign√©e
        ‚Üì
   Mandat consid√©r√© "ferm√©"
        ‚Üì
   ‚ùå CRG bloqu√©s
   ‚ùå Compte myFoncia restreint
```

**Mais** : rien n'emp√™che l'utilisateur de saisir cette date m√™me si des lots sont encore actifs !

### 3. Cas probl√©matique concret

```
Mandat GL-12345
‚îú‚îÄ‚îÄ Lot A : actif (endManagementDate = null)      ‚Üê Encore g√©r√© !
‚îú‚îÄ‚îÄ Lot B : actif (endManagementDate = null)      ‚Üê Encore g√©r√© !
‚îî‚îÄ‚îÄ finalClosingDate = 2025-01-15                 ‚Üê Saisi par erreur

R√©sultat :
- Lots toujours g√©r√©s en th√©orie
- Mais mandat "ferm√©" ‚Üí CRG bloqu√©s ‚Üí probl√®me !
```

### 4. Comportement attendu (cible)

```
Utilisateur veut saisir finalClosingDate
        ‚Üì
   V√©rification : tous les lots sont-ils inactifs ?
        ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  OUI (tous inactifs)   ‚îÇ  NON (au moins 1 actif)  ‚îÇ
   ‚îÇ         ‚Üì              ‚îÇ            ‚Üì             ‚îÇ
   ‚îÇ   ‚úÖ Saisie OK         ‚îÇ   ‚ùå Erreur + message    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Message d'erreur** :
> "Impossible de d√©finir une date de fin de mandat : des lots sont encore actifs. Veuillez d'abord cl√¥turer tous les lots."

---

## D√©finition d'un lot actif

Un lot est consid√©r√© comme **actif** si :
- `endManagementDate` est `null` ou `undefined`
- OU `endManagementDate` est dans le futur (> now)

**Code existant** (repository L.576-579) :
```typescript
const isActiveUnit = (unit: MandateUnitWithEndDate): boolean => {
  const endDate = unit.rentalManagement?.endManagementDate;
  return !endDate || new Date(endDate) > now;
};
```

---

## Architecture et Flux

### Sch√©ma global des flux

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         FRONTEND                                 ‚îÇ
‚îÇ   FinalClosingDateField (smarties)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Gateway    ‚îÇ        ‚îÇ    Plato     ‚îÇ
‚îÇ   GraphQL    ‚îÇ        ‚îÇ   REST API   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                       ‚îÇ
       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ service-lease‚îÇ        ‚îÇ rentalManagement     ‚îÇ
‚îÇ   Temporal   ‚îÇ        ‚îÇ Mandate.process.js   ‚îÇ
‚îÇ   Workflow   ‚îÇ        ‚îÇ                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                           ‚îÇ
       ‚ñº                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Use Case    ‚îÇ        ‚îÇ  ‚ö†Ô∏è VALIDATION ICI   ‚îÇ
‚îÇ  ‚ö†Ô∏è VALID.   ‚îÇ        ‚îÇ                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                           ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    MongoDB      ‚îÇ
         ‚îÇ rentalManagement‚îÇ
         ‚îÇ    Mandates     ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flux 1 : service-lease (via Gateway GraphQL)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Gateway       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  service-lease  ‚îÇ
‚îÇ   (smarties)    ‚îÇ     ‚îÇ   (GraphQL)     ‚îÇ     ‚îÇ    (server)     ‚îÇ
‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ
‚îÇ FinalClosing    ‚îÇ     ‚îÇ amendRental     ‚îÇ     ‚îÇ Temporal        ‚îÇ
‚îÇ DateField       ‚îÇ     ‚îÇ Management      ‚îÇ     ‚îÇ Workflow        ‚îÇ
‚îÇ                 ‚îÇ     ‚îÇ MandateMutation ‚îÇ     ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                         ‚îÇ
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ   service-lease (worker)        ‚îÇ
         ‚îÇ                                 ‚îÇ
         ‚îÇ  AmendRentalManagementMandate   ‚îÇ
         ‚îÇ  Workflow                       ‚îÇ
         ‚îÇ       ‚îÇ                         ‚îÇ
         ‚îÇ       ‚ñº                         ‚îÇ
         ‚îÇ  updateRentalManagementMandate  ‚îÇ
         ‚îÇ  Activity                       ‚îÇ
         ‚îÇ       ‚îÇ                         ‚îÇ
         ‚îÇ       ‚ñº                         ‚îÇ
         ‚îÇ  Use Case ‚ö†Ô∏è VALIDATION         ‚îÇ
         ‚îÇ       ‚îÇ                         ‚îÇ
         ‚îÇ       ‚ñº                         ‚îÇ
         ‚îÇ  MongoRepository.update()       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flux 2 : Plato REST API (BO direct)

```
PATCH /api/v1/housings/mandate-location/:id
    ‚îÇ
    ‚îú‚îÄ‚ñ∂ validator.updateOneRentalManagementMandate (Joi validation)
    ‚îÇ       ‚îî‚îÄ‚îÄ endMandateDate: joi.date()
    ‚îÇ
    ‚îú‚îÄ‚ñ∂ action.updateOneRentalManagementMandate
    ‚îÇ       ‚îî‚îÄ‚îÄ process.updateOneRentalManagementMandate(mandateId, req.body, req.user)
    ‚îÇ
    ‚îî‚îÄ‚ñ∂ process.updateOneRentalManagementMandate
            ‚îÇ
            ‚îú‚îÄ‚îÄ ‚ö†Ô∏è VALIDATION hasActiveUnits()
            ‚îú‚îÄ‚îÄ V√©rification des permissions utilisateur
            ‚îú‚îÄ‚îÄ Mise √† jour du lessorAccount (taxation)
            ‚îú‚îÄ‚îÄ Mise √† jour des branches (si changement)
            ‚îî‚îÄ‚îÄ MandateRentalManagementModel.findOneAndUpdate()
```

---

## Fichiers cl√©s

### Backend - service-lease

| Fichier | R√¥le |
|---------|------|
| `worker/src/rental-management-mandate/domain/update-rental-management-mandate.use-case.ts` | Use case avec validation |
| `worker/src/rental-management-mandate/repository/rental-management-mandate.repository.ts` | Interface `hasActiveUnits()` |
| `worker/src/rental-management-mandate/adapter/mongodb-rental-management-mandate.repository.ts` | Impl√©mentation MongoDB |
| `contract-rest/src/rental-management-mandate/schema.mts` | Schema Zod du payload (L.136) |
| `worker/src/rental-management-mandate/workflows.ts` | Orchestration Temporal |

### Backend - Plato

| Fichier | R√¥le |
|---------|------|
| `src/routes/housings/rentalManagementMandate/rentalManagementMandate.route.js` | Route PATCH (L.23-28) |
| `src/routes/housings/rentalManagementMandate/rentalManagementMandate.validator.js` | Validation Joi |
| `src/routes/housings/rentalManagementMandate/rentalManagementMandate.action.js` | Handler HTTP |
| `src/routes/housings/rentalManagementMandate/rentalManagementMandate.process.js` | Logique m√©tier + validation (L.544-655) |

### Frontend - Smarties

| Fichier | R√¥le |
|---------|------|
| `src/RentalManagementMandateForm/sections/PeriodicitySection/fields/FinalClosingDateField/index.tsx` | Champ de saisie |
| `src/RentalManagementMandateForm/hooks/useRentalManagementMandateForm.ts` | Hook qui envoie `finalClosingDate` (L.170) |
| `src/FicheCustomer/PageLessor/PageContracts/CardExternalTrusteeReferenceContracts/use-has-active-units-in-active-mandates.ts` | Hook existant pour lots actifs |

### Schema MongoDB

| Fichier | R√¥le |
|---------|------|
| `packages/model-plato/src/management/schemas/rentalManagementMandate.schema.mts` | D√©finition `finalClosingDate` (L.204-208) |

---

## Flux de validation impl√©ment√©s

### 1. Flux Plato (PATCH /api/rentalManagementMandates/:id)

```
updateOneRentalManagementMandate()
  ‚Üì
Si endMandateDate ou finalClosingDate fourni
  ‚Üì
validateNoActiveUnitsForEndDate()
  ‚Üì
hasActiveUnits() ‚Üí v√©rifie endManagementDate de chaque lot
  ‚Üì
Si actifs ‚Üí throw CommonException "MANDATE_HAS_ACTIVE_UNITS"
```

**Message d'erreur** : *"Impossible de d√©finir une date de fin de mandat : des lots sont encore actifs. Veuillez d'abord cl√¥turer tous les lots."*

### 2. Flux service-lease (Temporal Workflow)

```
updateRentalManagementMandate() [use-case]
  ‚Üì
Si finalClosingDate fourni
  ‚Üì
validateNoActiveUnitsForFinalClosingDate()
  ‚Üì
repository.hasActiveUnits()
  ‚Üì
Si actifs ‚Üí BusinessException "ActiveUnitsExistException"
```

**Message d'erreur** : *"Impossible de d√©finir une date de perte : des lots sont encore actifs sur ce mandat. Veuillez d'abord cl√¥turer tous les lots."*

---

## Fichiers modifi√©s (diff)

| Fichier | Description |
|---------|-------------|
| `applications/plato/src/routes/housings/rentalManagementMandate/rentalManagementMandate.process.js` | Route Plato (PATCH) - Validation c√¥t√© legacy |
| `applications/service-lease/worker/src/rental-management-mandate/repository/rental-management-mandate.repository.ts` | Interface repository |
| `applications/service-lease/worker/src/rental-management-mandate/adapter/mongodb-rental-management-mandate.repository.ts` | Impl√©mentation MongoDB - `hasActiveUnits()` |
| `applications/service-lease/worker/src/rental-management-mandate/domain/update-rental-management-mandate.use-case.ts` | Use case avec validation |

**Voir** : [PROD-28299-DIFF.md](./PROD-28299-DIFF.md) pour le diff d√©taill√©.

---

## Test

**Voir** : [LOCAL_BO_ACCESS.md](../agents/ml/LOCAL_BO_ACCESS.md) pour les instructions d'acc√®s au BO local.

### Donn√©es de test

| Champ | Valeur |
|-------|--------|
| **Cabinet** | FONCIA AD IMMOBILIER (0580) |
| **Bailleur** | 200209356 |
| **Mandat ID** | `64850e80954504c6fd1095bd` |
| **Mandat N¬∞** | 772459 |
| **Lot actif** | N¬∞1766 (sans `endManagementDate`) |

**URL Local** :
```
http://localhost:8081/customer/64850e80de2125571ec2a82b/lessor?activeLessor=64850e80954504c6fd1095bc&activeMandates=0&mandateId=64850e80954504c6fd1095bd
```

### Proc√©dure de test

1. Se connecter au BO via impersonate (cabinet AD Immobilier)
2. Acc√©der au bailleur 200209356
3. Ouvrir le mandat
4. Essayer de saisir une **Date de perte** (`finalClosingDate`)
5. **R√©sultat attendu** : Message d'erreur bloquant

### Requ√™tes MongoDB

```javascript
// V√©rifier l'√©tat du mandat
db.rentalManagementMandates.findOne(
  { _id: ObjectId("64850e80954504c6fd1095bd") },
  { finalClosingDate: 1, "units.rentalManagement.endManagementDate": 1 }
)

// R√©initialiser pour retest
db.rentalManagementMandates.updateOne(
  { _id: ObjectId("64850e80954504c6fd1095bd") },
  { $unset: { finalClosingDate: "" } }
)
```

---

## Tests cr√©√©s

| Couche | Fichier | Description |
|--------|---------|-------------|
| **Use Case** | `service-lease/worker/.../domain/use-cases/__tests__/update-rental-management-mandate.usecase.spec.ts` | Test unitaire du use case avec mock du repository |
| **Repository** | `service-lease/worker/.../adapter/__tests__/mongodb-rental-management-mandate.repository.spec.ts` | Test d'int√©gration de `hasActiveUnits()` |
| **Plato Process** | `plato/.../housings/rentalManagementMandate/rentalManagementMandate.spectegration.js` | Tests PROD-28299 ajout√©s au fichier existant |

### Commandes pour lancer les tests

```bash
# Pr√©requis : Docker doit √™tre d√©marr√©

# service-lease (Vitest)
pnpm nx test service-lease-worker -- -t "hasActiveUnits"
pnpm nx test service-lease-worker -- -t "UpdateRentalManagementMandateUseCase"

# Plato (Jest)
pnpm nx test:jest plato -- --testPathPatterns="rentalManagementMandate.spectegration"
# Ou pour les tests PROD-28299 uniquement :
pnpm nx test:jest plato -- --testNamePattern="PROD-28299"
```

---

## Lien avec INC-106061 (myFoncia restriction)

> **Contexte** : Ce ticket est li√© √† l'incident INC-106061 o√π des comptes myFoncia sont incorrectement restreints.

### Probl√®me d√©couvert

La logique de restriction myFoncia (`customerQualities.repository.ts`) calcule `isActive` au niveau du **LOT** (pas du mandat) :

```typescript
// Si TOUS les lots ont endManagementDate dans le pass√© ‚Üí compte restreint
isActive: {
  $cond: {
    if: { $or: [
      { $eq: ["$endManagementDate", null] },
      { $gt: ["$endManagementDate", new Date()] },
    ]},
    then: true,
    else: false,
  }
}
```

### Cons√©quence

```
Mandat openMandate: true (toujours ouvert)
‚îî‚îÄ‚îÄ Tous les lots avec endManagementDate dans le pass√©
    ‚Üì
Compte myFoncia RESTREINT (m√™me si mandat ouvert !)
```

### Ampleur (base locale)

| M√©trique | Valeur |
|----------|--------|
| Mandats `openMandate: true` avec lots "perdus" | ~32 785 |
| Lots avec `endManagementDate` pass√©e | ~70 206 |
| Mandats avec TOUS les lots "perdus" | ~77 839 |

### Lien avec PROD-28299

Ce ticket PROD-28299 emp√™che la saisie de `finalClosingDate` si des lots actifs existent, mais ne r√©sout pas le probl√®me inverse : des lots marqu√©s "perdus" alors que le mandat est toujours ouvert.

---

## Notes techniques

### Diff√©rence entre `endMandateDate` et `finalClosingDate`

| Champ | Description | Deprecated |
|-------|-------------|------------|
| `endMandateDate` | Date de fin l√©gale du mandat | ‚úÖ Oui (remplac√© par renewal) |
| `finalClosingDate` | Date de cl√¥ture d√©finitive du mandat | Non |

**Note** : Les deux champs sont concern√©s par la validation (Plato v√©rifie les deux, service-lease v√©rifie seulement `finalClosingDate`).

### Feature Flag existant

Le champ utilise d√©j√† un feature flag pour bloquer l'√©dition :
```typescript
const isLossDatesEditionBlocked = useHasFeatureFlag(
  FeatureFlags.BLOCK_LOSS_DATES_EDITION,
);
```

### Permissions

Le champ est prot√©g√© par une permission :
```typescript
SCOPES.PROPERTY__RENTAL_MANAGEMENT_MANDATE_FIELD_FINAL_CLOSING_DATE__UPDATE
```

---

## TODO

- [x] Lecture du contexte du ticket
- [x] Analyse du code modifi√©
- [x] Investigation INC-106061 (lien avec myFoncia)
- [x] Cr√©ation des tests unitaires et d'int√©gration
- [x] **Impl√©mentation frontend (blocage des champs)**
- [ ] Ex√©cuter les tests en local (Docker requis)
- [ ] Validation en PP

---

## üöÄ Impl√©mentation finale (2025-12-04)

### Approche choisie : Blocage Frontend + Find s√©par√©

L'impl√©mentation finale bloque les champs **"Date de perte"** et **"Motif de perte"** c√¥t√© frontend lorsqu'il y a des lots actifs sur le mandat. Cela couvre les deux vues :

1. **BO (ancien formulaire)** - via REST API Plato
2. **ADB (nouveau formulaire)** - via GraphQL Gateway

### ‚ö†Ô∏è Changement de strat√©gie (2025-12-04)

L'approche initiale avec `$lookup` + `$expr` + `$in` dans l'aggregation causait des **timeouts en production** car ce pattern ne peut pas utiliser les index MongoDB.

**Anti-pattern supprim√© :**
```typescript
// ‚ùå SUPPRIM√â - Causait des timeouts
$lookup: {
  from: "units",
  let: { unitIds: "$units.unit" },
  pipeline: [
    { $match: { $expr: { $in: ["$_id", "$$unitIds"] } } },  // scan complet !
  ],
  as: "unitsWithEndDates",
}
```

**Nouvelle approche :** `findOne` s√©par√© apr√®s l'aggregation, qui peut utiliser les index.

### Fichiers modifi√©s (commit 99161b8d36b)

| Composant | Fichier | Description |
|-----------|---------|-------------|
| **Backend Plato** | `applications/plato/.../unitsGroup/hasActiveUnits.ts` | **NOUVEAU** - Fonction performante |
| | `applications/plato/.../unitsGroup/unitsGroup.process.js` | Import + appel (2 lignes JS) |
| | ~~`applications/plato/.../unitsGroup/hasActiveUnits.aggregation.ts`~~ | **SUPPRIM√â** (anti-pattern) |
| | `packages/transformers/src/mappers/mandate.js` | Mapping `hasActiveUnits` pour REST |
| **Frontend BO** | `packages/smarties/.../SectionInformations/index.jsx` | Blocage champs ancien formulaire |
| **Frontend ADB** | `packages/smarties/.../RentalManagementMandateForm/hooks/mapper.ts` | Calcul `hasActiveUnits` GraphQL |
| | `packages/smarties/.../FinalClosingDateField/index.tsx` | Blocage champ date de perte |
| | `packages/smarties/.../LostContractMandateReasonField/index.tsx` | Blocage champ motif de perte |

### Calcul `hasActiveUnits`

#### Backend (TypeScript - performant)

**Nouveau fichier : `hasActiveUnits.ts`**
```typescript
import type { Types } from "mongoose";
import { UnitModel } from "$models/unit";

/**
 * A unit is considered "active" if:
 * - endManagementDate is null (no end date set)
 * - endManagementDate is undefined (field doesn't exist)
 * - endManagementDate is in the future
 */
export async function hasActiveUnits(
  unitIds: Types.ObjectId[],
): Promise<boolean> {
  const now = new Date();
  const activeUnit = await UnitModel.findOne({
    _id: { $in: unitIds },
    $or: [
      { "rentalManagement.endManagementDate": null },
      { "rentalManagement.endManagementDate": { $exists: false } },
      { "rentalManagement.endManagementDate": { $gt: now } },
    ],
  })
    .select("_id")
    .lean();

  return !!activeUnit;
}
```

**Appel dans `unitsGroup.process.js`**
```javascript
import { hasActiveUnits } from "./hasActiveUnits.ts";

// Dans getOneMandateGL()
mandate.hasActiveUnits = await hasActiveUnits(unitsGroup.units.map((u) => u.unit));
```

**Pourquoi c'est performant :**
- `$in` sur `_id` utilise l'index `_id` (toujours pr√©sent)
- `findOne` s'arr√™te au premier r√©sultat trouv√©
- `select("_id")` minimise les donn√©es transf√©r√©es
- `lean()` √©vite l'hydratation Mongoose

#### Frontend GraphQL (mapper.ts)

```typescript
import { isAfterToday } from "@foncia/transformers/utils/date";

const calculateHasActiveUnits = (
  buildings: RentalManagementMandatesBuildingsQuery,
): boolean => {
  return buildings.some((building) =>
    building.units.some((unit) => {
      const endManagementDate =
        unit.rentalManagementMandateUnit?.endManagementDate;
      return !endManagementDate || isAfterToday(endManagementDate);
    }),
  );
};
```

### Comportement UI

Quand `hasActiveUnits = true` :
- Les champs "Date de perte" et "Motif de perte" sont **d√©sactiv√©s**
- Un **helperText** s'affiche : *"Des lots sont encore actifs sur ce mandat"*

```tsx
<field.DateField
  label={t("Date de perte")}
  disabled={!isAuthorized || readOnly || isLossDatesEditionBlocked || hasActiveUnits}
  helperText={hasActiveUnits ? t("Des lots sont encore actifs sur ce mandat") : undefined}
/>
```

### Git

```
Branch: revert-34b6d3ca
Commit: 99161b8d36b feat: has active units
```

**Fichiers dans le commit :**
- `hasActiveUnits.ts` (nouveau, 30 lignes)
- `hasActiveUnits.aggregation.ts` (supprim√©, -55 lignes)
- `unitsGroup.process.js` (+2 lignes)

### Notes

- Les modifications backend service-lease initialement pr√©vues ont √©t√© **revert√©es**
- L'approche frontend-only est suffisante car la validation m√©tier n'est pas critique (pas de risque de corruption de donn√©es)
- Le feature flag `BLOCK_LOSS_DATES_EDITION` reste actif en compl√©ment
- **Performance** : L'anti-pattern `$lookup` + `$expr` + `$in` a √©t√© remplac√© par un `findOne` s√©par√© qui utilise les index

---

## Crit√®res d'acceptation

- [ ] Un utilisateur ne peut pas saisir de `finalClosingDate` si des lots actifs existent
- [ ] Un message d'erreur clair est affich√© c√¥t√© frontend
- [ ] L'API retourne une erreur 400 avec un code explicite si tentative de bypass
- [ ] Les lots actifs sont d√©finis par `endManagementDate` null/undefined ou dans le futur
- [ ] Tests unitaires et d'int√©gration couvrent les cas nominaux et edge cases

---

## Plan d'impl√©mentation (historique)

### 1. Backend - Validation dans le Use Case

**Fichier** : `applications/service-lease/worker/src/rental-management-mandate/domain/update-rental-management-mandate.use-case.ts`

**Actions** :
1. Ajouter une m√©thode `validateFinalClosingDate(mandateId, finalClosingDate)`
2. R√©cup√©rer le mandat avec ses lots via le repository
3. V√©rifier si des lots actifs existent
4. Retourner une `BusinessException<"ActiveUnitsExistException">` si blocage

**Nouvelle exception** :
```typescript
new BusinessException(
  "ActiveUnitsExistException",
  "Impossible de d√©finir une date de perte : des lots actifs existent sur ce mandat",
  { mandateId, activeUnitsCount }
)
```

### 2. Repository - M√©thode de v√©rification

**Fichier** : `applications/service-lease/worker/src/rental-management-mandate/adapter/mongodb-rental-management-mandate.repository.ts`

**Actions** :
1. Ajouter une m√©thode `hasActiveUnits(mandateId): Future<Result<boolean, TechnicalException>>`
2. R√©utiliser la logique `isActiveUnit` existante

### 3. Plato - Validation dans le process

**Fichier** : `applications/plato/src/routes/housings/rentalManagementMandate/rentalManagementMandate.process.js`

**Exemple de validation** :
```javascript
// Dans updateOneRentalManagementMandate (process.js)
if (mandateData.endMandateDate || mandateData.finalClosingDate) {
  const mandateWithUnits = await MandateRentalManagementModel.findById(mandateId)
    .select("+units.rentalManagement.endManagementDate")
    .lean();

  const now = new Date();
  const hasActiveUnits = mandateWithUnits.units.some(unit => {
    const endDate = unit.rentalManagement?.endManagementDate;
    return !endDate || new Date(endDate) > now;
  });

  if (hasActiveUnits) {
    throw new CommonException(
      "Impossible de d√©finir une date de fin de mandat : des lots sont encore actifs",
      {
        statusCode: StatusCodes.BAD_REQUEST,
        specificCode: "MANDATE_HAS_ACTIVE_UNITS",
      },
      { mandateId }
    );
  }
}
```

### 4. Frontend - Blocage du champ (optionnel)

**Fichier** : `packages/smarties/src/RentalManagementMandateForm/sections/PeriodicitySection/fields/FinalClosingDateField/index.tsx`

**Actions** :
1. Ajouter un hook pour v√©rifier les lots actifs du mandat
2. D√©sactiver le champ si des lots actifs existent
3. Afficher un message explicatif (tooltip ou texte d'aide)

---

## R√©f√©rences

- Schema MongoDB : `rentalManagementMandate.schema.mts`
- Documentation data model : `documentation/docs/data/plato/rentalManagementMandates.md`
- Hook lots actifs : `use-has-active-units-in-active-mandates.ts`
- Diff complet : [PROD-28299-DIFF.md](./PROD-28299-DIFF.md)
