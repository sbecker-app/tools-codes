---
ticket: PROD-28497
status: fixed
date: 2025-12-04
cabinet: AD Immobilier (0580)
building: 501270043 (LES BASTIDES DES PLANS)
tags: [RCL, INDEX, PData, duplication]
---

# PROD-28497 - Multiplication des lignes INDEX dans RCL

## Symptôme

Après exécution du script ML Admin "Forcer la RCL avec des valeurs pour les lots en gérance", les lignes de type INDEX (clés 810, 830) sont multipliées/triplées dans le détail de calcul RCL.

Exemple pour lot 151 (D25) :
- 3 lignes "301 - EAU R" sous clé 810 au lieu d'une seule
- 3 lignes "301 - EAU R", "302 - ELECTRICITE R", "304 - COMBUSTIBLES" sous clé 830

## Cause racine

**Deux problèmes distincts :**

### 1. Groupement incorrect des lignes comptables

Après PData merge, les expenses référencent des `_id` différents pour les mêmes `allocationKey.number` et `expenseType.code`. Le groupement par `_id` créait plusieurs groupes au lieu d'un seul.

### 2. Création d'une entrée par unité

Pour les clés INDEX PData (sans compteurs physiques), la fonction `getIndexFluids` itérait sur toutes les unités du lease et créait une entrée pour chacune. Un lot avec 3 unités (1 appartement + 2 parkings) générait donc 3 lignes par expenseType.

## Fixes appliqués

### Fix 1 : Groupement par number/code

**Fichier :** `applications/plato/src/routes/accounting/rentalManagement/expenseRegularization/processes/legacyAllocationKeyWithDataLost/createExpenseRegularization.process.ts`

```typescript
// Ligne 384 - Grouper par allocationKey.number (pas _id)
const expByAllocationKey = _.groupBy<RegularizationPeriodExpense>(
  leaseExpenses,
  ({ allocationKey }) => allocationKey.number,
);

// Ligne 394 - Grouper par expenseType.code (pas _id)
const expByExpenseTypeKey = _.groupBy(
  allocationExpenses,
  ({ expenseType }) => expenseType.code,
);
```

### Fix 2 : Agrégation des unités pour clés PData INDEX

**Fichier :** `applications/plato/src/routes/accounting/rentalManagement/expenseRegularization/processes/legacyAllocationKeyWithDataLost/computations/expenseType.computation.ts`

```typescript
// Dans getIndexFluids(), lignes 68-113
if (!expensesPerExpenseType[0].allocationKey.accountingPeriod) {
  const units = expensesPerExpenseType[0].allocationKey?.units;

  // Si des unités ont des fluids (compteurs physiques), comportement normal
  const unitsWithFluids = units?.filter((unit) => unit.fluids?.length) ?? [];
  if (unitsWithFluids.length > 0) {
    return unitsWithFluids.flatMap((unit) =>
      unit.fluids!.map((fluid) =>
        __computeUnitFluidIndex(accountingPeriod, lease, fluid, unit, leaveMeasurements),
      ),
    );
  }

  // PROD-28497: Clés PData sans compteurs physiques
  // Agréger toutes les unités en UNE SEULE entrée
  const totalFractionalShares =
    units?.reduce((sum, unit) => sum + (unit.fractionalShares ?? 0), 0) ?? 0;

  if (Number.isFinite(totalFractionalShares)) {
    const firstUnit = units?.[0];
    return [
      mapExpenseRegularizationExpenseTypeFluid({
        lease,
        fluid: {
          deviceNumber: "N/A",
          fractionalShares: totalFractionalShares,
          oldIndex: undefined,
          newIndex: undefined,
          isPackage: false,
        },
        unit: {
          _id: firstUnit?._id.toHexString() ?? "",
          fractionalShares: totalFractionalShares,
        },
      }),
    ];
  }
  return [];
}
```

## Logique des deux fixes

| Fix | Fichier | Rôle |
|-----|---------|------|
| Fix 1 | `createExpenseRegularization.process.ts` | Grouper correctement les lignes comptables avec même numéro de clé/code |
| Fix 2 | `expenseType.computation.ts` | Ne pas créer une ligne par unité → agréger en une seule entrée |

**Les deux fixes sont nécessaires et complémentaires.**

## Données de test

**CSV utilisé :** `projects/ml/data/INDEX_RCL.csv`

```csv
building;Exercice;lot;compteur;index;consomation_totale;consomation_compteur
501270043;64850e805c3dd747649b3067;151;D25;810;5353;79
501270043;64850e805c3dd747649b3067;151;D25;830;2268;31
```

**IDs MongoDB :**
- Building : `64850e80f65e38c9af1fe300`
- Accounting Period : `64850e805c3dd747649b3067`
- Lease lot 151 : `64850e800906b30fb7f79565`

## Résultat attendu

Pour le lot 151 sous clé 810 :
- **Avant fix :** 3 lignes "301 - EAU R" (79/5353, 0/5353, 0/5353)
- **Après fix :** 1 ligne "301 - EAU R" (79/5353)

## Vérification

1. Lancer ML Admin script "Forcer la RCL avec des valeurs pour les lots en gérance"
2. Utiliser le CSV `INDEX_RCL.csv`
3. Cocher "Supprimer les clés existantes"
4. Vérifier le détail du lot 151 → une seule ligne par expenseType sous clés 810 et 830
